# 文件管理

### 考查点

- 考纲内容

	- 1. 文件系统的基础

		- 文件的逻辑结构

			- 顺序文件
			- 索引文件
			- 索引顺序文件

		- 目录结构

			- 文件控制块和索引结点
			- 单级目录结构和两级目录结构
			- 树形目录结构
			- 图形目录结构

		- 文件共享、文件保护、访问类型、访问控制

	- 2. 文件系统的实现

		- 文件系统层次结构
		- 目录实现
		- 文件实现

	- 3. 磁盘组织与管理

		- 磁盘调度算法
		- 磁盘的管理

- 复习提示

	- 重点掌握文件系统的结构及其实现、磁盘的相关知识点

### 概念

- 文件的定义

	- 一组有意义的信息的集合

- 文件的属性

	- 名称（唯一）、标识符（标识文件系统内文件的唯一标签）、类型、位置、大小、保护、时间

### 文件逻辑结构

文件结构包括**逻辑结构**和**物理结构**

1.逻辑结构是用户组织数据的结构形式, 数据组织形式来自需求（**取决于用户**）
2.而物理结构是操作系统组织物理存储块的结构形式（**取决于文件系统设计者所采取的策略**）

- 无结构文件（流式文件）

  由二进制流或字符流组成, 无明显的逻辑结构

- 有结构文件（记录式文件）

  由记录组成, 分为定长记录、可变长记录

	- 顺序文件

		- 串结构

			- 记录顺序与关键字无关

		- 顺序结构

			- 记录按关键字顺序排列

		- 定长与可变长记录

			- 可变长记录的顺序文件无法实现随机存取（每次查询只能从头依次查找），定长记录可以
			- 定长记录、顺序结构的顺序文件可以快速检索（根据关键字快速找到记录）

		- 不方便增加 / 删除记录

	- 索引文件

		- 解决了顺序文件中不方便增 / 删记录的问题，同时让不定长记录的文件实现了随机存取
		- 索引表本身就是定长记录的顺序文件，一个索引表就是一条定长记录
		- 所索引表按关键字顺序排序，则可支持快速检索
		- 由逻辑文件和索引表组成

	- 索引顺序文件

		- 解决了索引文件中存储空间利用率过低的问题
		- 检索记录时先按顺序查索引表，找到分组，再顺序查找分组
		- 当记录过多时可以建立多级索引表

### 目录结构

- 文件控制块（FCB）、索引结点

	- 文件控制块（FCB）

	  为了实现 **"按名存取"**, 在文件系统中为每个文件设置用于描述和控制文件的**数据结构**, 称之为文件控制块(**FCB**)

		- 用来存放控制文件需要的各种信息的数据结构
		- 一个文件对应一个FCB，一个FCB就是一个目录项，多个FCB组成文件目录

	- 索引结点

		- 相对于 FCB 可减少启动磁盘次数，进而节省系统开销
		- 文件描述信息单独形成一个称为索引结点的数据结构，简称 i 结点
		- 存放在磁盘（外存）上的索引结点称为磁盘索引结点，当索引结点放入内存后称为内存索引节点

- 单级目录结构

	- 一个系统中只有一张目录表，不可重名、查找速度慢、不便于文件共享
	- 单级目录结构示例图

		- 

- 两级目录结构

	- 将文件目录分成主文件目录（MFD）及用户文件目录（UFD）
	- 不同用户的文件可以重名，但是不能对文件进行分类
	- 两级目录结构示例图

		- 

- 树形目录结构

	- 不同目录下的文件可以重名，也可以对文件进行分类，但不方便文件共享
	- 绝对路径

		- 从根目录出发的路径

	- 当前目录

		- 从当前目录出发的路径（可减少磁盘 I/O 次数）

	- 树形目录结构示例图

		- 

- 图形目录结构

	- 在树形目录结构的基础上，增加了一些指向同一结点的有向边，使整个目录成为了一个有向无环图
	- 无环图目录结构方便地实现了文件共享，但使得系统的管理变得更加复杂
	- 为共享结点设置一个共享计数器，其为 0 时才真正删除该结点
	- 图形目录结构示例图

		- 

### 文件共享

- 静态共享方法

	- 基于索引结点（硬链接）

		- 多个指针指向一个索引结点，保证只要还有一个指针指向索引结点，索引结点就不能删除
		- 删除文件时，只是删除该用户的目录项，且 ﻿
		- ﻿ 时才真正删除文件数据和索引结点

	- 利用符号链实现（软链接）

		- 若共享文件已被删除，而 Link 型文件仍然存在，只是无法再通过该文件中的路径去查找共享文件（找不到对应目录项）
		- 把共享文件的路径记录下来，当要访问文件时，根据路径寻找文件（Windows 快捷方式）
		- 访问共享文件时要查询多级目录，会有多次磁盘 I/O 操作，因此访问速度要比硬链接慢

	- 注意点：建立符号链接（软链接）时，引用计数值直接复制；建立硬链接时，引用计数值加 1

- 动态共享方法

	- 允许两个进程同时对一个文件进行操作，这样的共享称为动态共享

### 文件保护

- 访问类型

	- 读、写、执行、添加、删除、列表清单

- 口令保护

	- 为文件设置一个“口令”，用户想要访问文件时需要提供口令，由系统验证口令是否正确
	- 实现开销小，但“口令”一般存放在 FCB 或索引结点中（系统中），因此不安全

- 加密保护

	- 用一个“密码”对文件加密，用户想要访问文件时，需要提供相同的密码才能正确地解密
	- 安全性高，但加密 / 解密需要耗费一定的时间（例如异或加密）

- 访问控制

	- 用一个访问控制表（ACL）记录各个用户（或各组用户）对文件的访问权限
	- 实现灵活，可以实现复杂的文件保护功能

### 实现

**文件的实现**就是研究文件的**物理结构**, 即文件数据在物理存储设备上是如何分布和组织的

- 层次结构

	- 1. 用户调用接口

		- 用于处理用户发出的系统调用请求（如Read、Write、Open、Close）

	- 2. 文件目录系统

		- 根据用户给出的文件路径找到相应的 FCB 或索引结点

	- 3.  存取控制验证模块

		- 验证用户是否有访问权限，以确保访问的合法性

	- 4. 逻辑文件系统与文件信息缓冲区

		- 将记录号转换为对应的逻辑地址

	- 5. 物理文件系统

		- 将文件逻辑地址转换为实际的物理地址

	- 6. 辅助分配模块

		- 负责文件存储空间的管理，即分配与回收

	- 7. 设备管理程序模块

		- 直接与硬件交互，负责和硬件直接相关的一些管理工作

- 目录实现

  注意: 目录的实现是为了**查找**

	- 线性表（对应线性查找）

		- 优点：实现简单
		- 缺点：费时

	- 哈希表（对应散列查找）

		- 优点：查找迅速、插入和删除也较简单
		- 缺点：需要一些预备策略来避免冲突

- 文件分配

	- 连续分配

		- 支持顺序访问与直接访问
		- 优点：实现简单，存取速度快
		- 缺点：文件长度不宜动态增加，反复删除文件后会产生外部碎片，仅适用于长度固定的文件

	- 链接分配

		- 优点：可解决外部碎片问题，动态增长较方便
		- 缺点：只能通过指针顺序访问文件，查找效率低且指针信息消耗外存空间
		- 分类

			- 隐式链接
			- 显示链接

				- 文件分配表（File Allocation Table）

				  操作系统可以通过**FAT**对文件存储空间进行管理

	- 索引分配

		- 优点：解决链接分配不能有效支持直接访问（FAT），及连续分配含有外部碎片的问题

		  **随机访问**且**易扩展**是索引结构的特性

		- 缺点：索引表增加了存储空间的开销
		- 解决索引块太小无法支持大文件的方法

			- 链接方案、多层索引、混合索引

	- 文件三种分配方式的比较示例图

		- 

- 存储空间管理

  文件存储空间管理即文件**空闲**空间管理

	- 空闲表法
	- 空闲链表法
	- 位示图法
	- 成组链表法

	  结合空闲表和空闲链表两种方法

### 磁盘

- 基本概念

	- 磁盘、磁道、扇区

		- 磁盘由表面涂有磁性物质的圆形盘片组成
		- 每个盘片被划分为一个个磁道，每个磁道又划分为一个个扇区

	- 如何在磁盘中读 / 写数据

		- 磁头移动到目标位置，盘片旋转，对应扇区划过磁道才能完成读 / 写

	- 盘面、柱面

		- 磁盘有多个盘面 “摞”起来，每个盘片有两个盘面
		- 所有盘面中相对位置相同的磁道组成柱面

	- 磁盘的物理地址

		- 由 柱面号 ● 盘面号 ● 扇区号（或块号）组成

	- 磁盘的分类

		- 根据磁头是否可移动

			- 固定头磁盘（每个磁道有一个磁头）
			- 移动头磁盘（每个盘面只有一个磁头）

		- 根据磁盘是否可更换

			- 固定盘磁盘
			- 可换盘磁盘

- 访问时间

  一次磁盘读写操作的时间由**寻找（寻道）时间**、**旋转延迟时间**和**传输时间**所决定

	- 寻道时间

		- 将磁头移动到指定磁道所需要的时间
		- 因要移动磁臂，故占用时间最长

	- 延迟时间

		- 将磁头定位到某一磁道的扇区（块号）所需要的时间

	- 传输时间

		- 从磁盘读取或向磁盘写入数据所经历的时间

	- 注意点

		- 寻道、延迟时间属于“找”的时间，都可以进行优化
		- 传输时间由磁盘本身性质所决定的，不可以进行优化

- 调度算法

  磁盘调度的目的是缩短**找道(即寻)时间**

	- 先来先服务（FCFS）

		- 根据进程请求访问磁盘的先后顺序进行调度

	- 最短寻找时间优先（SSTF）

		- 处理与当前磁头所在磁道距离最近的磁道，以便使每次的寻找时间最短

	- 扫描算法（SCAN）

		- 在 SSTF 算法的基础上规定了磁头的运动方向，如沿磁道号增大的顺序移动

	- 循环扫描（C-SCAN）

		- 解决了 SCAN 算法对于各个位置磁道的响应频率不平均的问题

	- 四种磁盘调度算法的优缺点示例图

		- 

- 磁盘的管理

	- 初始化

		- 1. 低级格式化/物理格式化，即划分扇区及为每个扇区采用特别的数据结构，包括校验码
		- 2. 将磁盘分为一个或多个柱面组成的分区（如C、D、E盘），每个分区可作为一个独立的磁盘
		- 3. 对物理分区进行逻辑格式化，即建立文件系统，将初始的文件系统数据结构存储道磁盘上

	- 引导块

		- 计算机启动时需要运行初始化程序（自举程序）来完成初始化
		- ROM中存放很小的自举装入程序，完整的存放在初始块（引导块）中

	- 坏块

		- 简单的磁盘：逻辑格式化时将坏块标记出来，对操作系统不透明
		- 复杂的扇区：磁盘控制器维护一个坏块链，并管理备用扇区，对操作系统透明
