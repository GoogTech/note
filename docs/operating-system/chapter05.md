# 输入/输出管理

### 考查点

- 考纲内容

	- I/O管理概念

		- I/O控制方式
		- I/O软件层次结构

	- I/O核心子系统

		- I/O调度概念
		- 高速缓冲与缓冲区
		- 设备分配与回收
		- 假脱机技术（SPOOLing）

- 复习提示

	- 重点掌握 I/O设备的的基本特性、I/O子系统的特性、三种I/O控制方式、高速缓冲与缓冲区、SPOOLing技术

### 概述

- I/O设备分类

	- 按使用特性分类

		- 人机交互类外部设备、存储设别、网络通信设备

	- 按传输速率分类

		- 低速设备、中速设备、高速设备

	- 按信息交换的单位分类

		- 块设备：存取的基本单位为数据块、传输速率高、可寻址
		- 字符设备：传输的基本单位为字符、传输速率低、不可寻址

- I/O控制方式

	- 程序直接控制

		- 优点：简单且易实现
		- 缺点：CPU和I/O设备只能串行工作，CPU需一直轮询检查，长期处于“忙等”状态，进而CPU利用率低

	- 中断驱动方式

		- 优点：CPU和I/O设备可以并行工作，CPU利用率得到明显提升
		- 缺点：每个字在I/O设备与内存之间的传输，都需经过CPU，而频繁的中断处理会消耗较多的CPU时间

	- DMA方式

		- 优点：DMA直接与存储器交互，传送过程不需要CPU参与. 数据传输以“块”为单位，使CPU接入频率进一步降低
		- 缺点：CPU每发出一条I/O指令，只能读/写一个或多个连续的数据块
		- 在I/O设备和主存之间建立一条直接数据通路

	- 通道技术

		- 优点：CPU、通道、I/O设备可并行工作，资源利用率很高
		- 缺点：实现复杂，需要专门的通道硬件支持
		- 用于实现内存与外设之间的信息传输

	- 四种I/O控制方式的对比示例图

		- 

- I/O层次结构

	- 1.用户层

		- 实现与用户交互的接口，用户直接调用在用户层提供的、与I/O操作有关的库函数

	- 2.设备独立性软件层（系统调用的处理程序）

		- 实现用户程序与设备驱动器的统一接口、接口命令、设备保护及设备分配与释放等
		- 逻辑设备表（LUT，Logical Unit Table）

			- 设备映射表中记录了逻辑设备所对应的物理设备，体现了两者的对应关系

	- 3.设备驱动层

		- 与硬件直接相关，负责具体实现系统对设备发出的操作指令，驱动I/O设备工作的驱动程序

	- 4.中断处理层

		- 用于保护被中断进程的CPU环境，转入相应的中断处理程序进行处理

	- 5.硬件层

		- 由机械部件、电子部件组成，用于执行I/O操作
		- 电子部件（设备控制器，I/O控制器）

		  CPU无法直接控制I/O设备的机械部件, 因此I/O设备还要有一个电子部件作为**CPU**和**I/O设备机械部件**之间的**"中介"**, 用来实现CPU对设备的控制, 这个电子部件就是**I/O控制器**, 又称**设备控制器**.

			- 主要功能

				- 接受和识别CPU发出的命令（要有控制寄存器）
				- 向CPU报告设备的状态（要有状态寄存器）
				- 数据交换（要有数据寄存器，暂存输入/输出的数据）
				- 地址识别（由I/O逻辑实现）
				- I/O逻辑即设备控制器，用来实现对设备的控制

			- 组成

				- CPU与控制器之间的接口（实现控制器与CPU之间的通信）
				- 控制器与设备之间的接口（实现控制器与设备之间的通信）
				- I/O逻辑（负责识别CPU发出的命令，并向设备发出命令）

### 缓冲区

- 概念

	- 因硬件成本高而且容量也比较小，故一般利用内存作为缓冲区
	- 特点：缓冲区的数据非空时，不能往缓冲区冲入数据. 必须把缓冲区充满后，才能才缓冲区把数据传出
	- 作用：缓解CPU与设备的速度矛盾、减少对CPU的中断频率、解决数据粒度不匹配的问题、提高CPU与I/O设备之间的并行性

- 单缓冲

	- 处理一块数据平均耗时 Max(C, T) + M
	- 分析问题的初始状态：工作区满、缓冲区空

- 双缓冲

	- 处理一块数据平均耗时 Max(T, C+M)
	- 分析问题的初始状态：工作区空、一个缓冲区满、另一个缓冲区空

- 循环缓冲

	- 多个缓冲区链接成循环队列，in指针指向第一个空缓冲区，out指针指向第一个满缓冲区

- 缓冲池

	- 三个队列

		- 空缓冲队列、输入队列（装满输入数据的缓冲队列）、输出队列（装满输出数据的缓冲队列）

	- 四种工作缓冲区

		- 用于收容输入数据的工作缓冲区、用于提取输入数据的工作缓冲区
		- 用于收容输出数据的工作缓冲区，用于提取输出数据的工作缓冲区

- 高速缓存与缓冲区的对比示例图

	- 

### 设备分配

- 概述

	- 独占设备：独占式使用
	- 共享设备：分时式共享
	- 虚拟设备：SPOOLing（Simultaneous Peripheral Operation System）方式

- 策略

	- 静态分配

		- 进程运行前为其一次性分配全部所需资源，不会出现死锁

	- 动态分配

		- 进程运行过程中根据执行需要动态申请设备资源，可能出现死锁

- 数据结构

	- 设备控制表（DCT）

		- 每个设备对应一张DCT
		- 关键字段：类型 / 标识符 / 状态 / 指向COCT的指针 / 等待队列指针

	- 控制器控制表（COCT）

		- 每个控制器对应一张COCT
		- 关键字段：状态 / 指向CHCT的指针 / 等待队列指针

	- 通道控制表（CHCT）

		- 每个控制器对应一张CHCT
		- 关键字段：状态 / 等待队列指针

	- 系统设备表（SDT）

		- 记录整个系统所有设备的情况，每个设备对应一个表目
		- 关键字段：设备类型 / 标识符 / DCT / 驱动程序入口

- 分配步骤

	- 1. 根据进程请求的物理设备名查找SDT
	- 2.根据SDT找到DCT并分配设备
	- 3.根据DCT找到COCT并分配控制器
	- 4.根据COCT找到CHCT并分配通道

- 安全性

	- 安全分配方式

		- 优点：设备分配安全
		- 缺点：对于同一个进程而言，CPU与I/O设备是串行工作的

	- 不安全分配方式

		- 优点：一个进程可以同时操作多个设备
		- 缺点：可能会产生死锁

- 设备分配步骤的改进

	- 逻辑设备表（LUT）

		- 用户编程时使用逻辑设备名申请设备，LUT负责实现从逻辑设备名到物理设备名的映射

		  用户程序对I/O设备的请求采用**逻辑设备名**, 而程序执行时使用**物理设备名**, 它们之间的转换是由**设备无关层**完成的

	- 逻辑设备表的设置问题

		- 整个系统只设置一张LUT

			- 各用户所用的逻辑设备名不允许重复

		- 每个用户设置一张LUT

			- 各个用户设备名可重复

### SPOOLing系统

- 组成

	- 输入井，输出井

		- 模拟脱机输入/输出时的磁带

	- 输入缓冲区、输出缓冲区

		- 模拟脱机输入/输出时的外围控制机

	- 输入设备、输出设备

		- 内存中的缓冲区，输入、输出时的“中转站”

- 脱机技术

	- 外围控制机 + 更高速的设备（磁带）
	- 作用：缓解设备与CPU的速度矛盾，实现预输入、缓输出

- 假脱机技术

	- 又称为SPOOLing技术，用软件的方式模拟脱机技术

	  SPOOLing技术是操作系统中采用的一种将**独占设备**改造为**共享设备**的技术,其主要**目的**是提高系统资源 / 独占设备的利用率

- 实例（共享打印机）

	- 用SPOOLing技术将独占式的打印机“虚拟”成共享打印机
