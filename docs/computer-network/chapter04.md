# 网络层

### 概念

- 向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务

### 功能

- 异构网络互联

	- 物理层中继系统

		- 中继器、集线器（Hub）

	- 数据链路层中继系统

		- 网桥或交换机

	- 网络层中级系统

		- 路由器（网关）

	- 网络层以上的中级系统

		- 网关

- 路由转发

	- 路由选择

		- 构造、更新、动态维护路由表

	- 路由转发

		- 通过路由表得出的转发表，将 IP 数据报从合适的端口转发出去

- 阻塞控制

	- 通过吞吐量和网络负载可判断网络是否阻塞
	- 阻塞控制是指必须确保通信子网能够传送待传达的数据
	- 流量控制是指抑制发送端发送数据的速率，以便接收方来得及接收
	- 方法

		- 开环控制

			- 静态防御方法，事先考虑周全，中途不能修改

		- 闭环控制

			- 动态防御方法，采用监视以及及时检测手段

### 路由算法

- 静态路由算法（非自适应）

	- 需手工配置的路由信息，不能及时适应网络的变化
	- 简便、开销小，但路由更新慢、不适用大型网络

- 动态路由算法（自适应）

	- 路由表项由路由器之间彼此交换信息，然后按一定算法优化而来
	- 性能佳、有助于流量控制，但算法复杂
	- 分类

		- 距离-向量路由算法

			- 路由器只掌握物理相连的邻居及链路费用
			- 为它的邻居提供从自己到网络中所有其他结点的最低费用估计

		- 链路状态路由算法

			- 所有路由器掌握完整的网络拓扑和链路费用信息
			- 仅告诉它们与它直接相连的链路的费用

- 层次路由

	- 解决因网络规模过大，而导致路由表成比例增大的问题
	- 内部网关协议（IGP）

		- RIP、OSPF

	- 外部网关协议（EGP）

		- BGP

### IPv4

- 概念

	- 采用点分十进制表示法
	- 由网络号和主机号两部分组成，即 IP地址 :: = {，}

- 数据报分片

	- 当数据报的总长度超过最大传送单元（MTU）则需进行分片
	- DF表示是否允许分片（0表示可以被分片），MF表示后面是否还有分片（0表示最后一个片）

- 特殊的IP地址

	- 主机号全为 0 或 1

		- 全为 0 表示网络本身，如 202.98.174.0
		- 全为 1 则表示直接广播地址，如 202.98.174.255

	- 32位全为 0 或 1

		- 全为 0 表示本网络上的本主机，如 0.0.0.0
		- 全为 1 则表示受限广播地址，如 255.255.255.255

	- 127.x.x.x

		- 环回自检（Lookback Test）地址，其域名为 localhost，如 127.0.0.1

- 私有IP地址网段

	- 私有IP必须通过网关利用NAT，将其转换为Internet中合法的全球IP地址后才能正常上网
	- A类

		- 1个网段，即 10.0.0.0 ~ 10.255.255.255

	- B类

		- 16个B类网段，即 172.16.0.0 ~ 172.31.255.255

	- C类

		- 256个C类网段，即 192.168.0.0 ~ 192.168.255.255

- 分类的IP地址示例图

	- 

- 常用的三种类别 IP 地址的使用范围示例图

	- 

### 解决IP地址耗尽

- NAT

	- 通过将专用网络地址转换为公用地址，从而实现对外隐藏，降低受到网络攻击的风险
	- NAT转换表中存放着 {本地IP地址 : 端口号} 到 {全球IP地址 : 端口号} 的映射

- 子网划分

	- 解决两级IP地址空间的利用率有时很低的问题
	- 将两级IP地址变成三级IP地址，即 IP地址 = {，，}
	- 子网掩码

		- IP地址和其对应的子网掩码逐位"与"，即可得出相应子网的网络地址
		- A、B、C类地址默认的子网掩码分别为255.0.0.0、255.255.0.0、255.255.255.0

- CIDR

  无分类域间路由选择

	- 作用是把小的网络汇聚成大的超网
	- 无分类两级IP地址为 IP :: = {，}

### 协议

- ARP

	- 即地址解析协议，用于完成IP地址到MAC地址的映射（过程自动）
	- ARP请求分组是广播发送的，而ARP响应分组时普通的单播

- DHCP

	- 即动态主机配置协议，即插即用，常用于给主机动态分配临时IP地址
	- 属于应用层协议，基于UDP，通过客户/服务器方式工作

- ICMP

	- 即网络控制报文协议，用于提供IP数据报交付成功的机会
	- PING使用了ICMP的询问报文中的回送请求和回答报文
	- 种类

		- ICMP差错报告
		- ICMP询问报文

- IGMP

	- 使路由器知道组播组成员的信息，即是否有主机参加或退出

### IPv6

- 表示

	- 采用冒号十六进制记法，相继为 0 的值域可以用双冒号::代替
	- 每4位用一个十六进制数表示，并用冒号:分割每16位

- 特点

	- 不允许分片
	- 取消校验和字段
	- 从IPv4的32位增大了128位
	- 即插即用，无需DHCP协议
	- 首部长度必须是8B的整数倍，而IPv4则为4B的整数倍

- 类型

	- 单播、多播、任播地址

- IPv4过渡到IPv6

	- 双协议栈

		- 同一台设备上同时装有IPv4和IPv6协议栈

	- 隧道技术

		- 将整个IPv6数据报封装到IPv4数据报的数据部分

### 路由协议

- 自治系统（AS）

	- 域内路由选择

		- 自治系统内部的路由选择

	- 域间路由选择

		- 自治系统之间的路由选择

- 内部网关协议（IGP）

	- RIP

	  路由信息协议

		- 只向自治系统中的相邻路由器发布路由信息
		- 距离为16时表示网络不可达，故仅适用于小型网络
		- 每30秒广播一次RIP路由更新信息，动态维护路由表

	- OSPF

	  最短路径优先协议

		- 通过洪泛法向自治系统中的所有路由器发送信息
		- 无RIP中的“坏消息传播的慢”的问题，适用于大型网络
		- 每隔一段时间刷新一次数据库中的链路状态，确保链路状态数据库与全网状态同步
		- 工作原理

			- 1. 各路由器之间频繁交换链路状态信息，最终构建链路状态数据库（拓扑结构图）
			- 2. 然后借助Dijkstra最短路径算法计算自己到各目的网络的最优路径，依次构造路由表
			- 3. 当链路状态发生变化时，重新执行以上步骤

- 外部网关协议（EGP）

	- BGP

	  边界网关协议

		- 用于不同自治系统的路由器之间交换路由信息
		- 力求找一条能够到达目的网路且比较好的路由，而非最佳路由

- RIP、OSPF、BGP三种协议的比较示例图

	- 

### IP组播

- 应用于视频点播和视频会议等多媒体应用
- 应用于UDP，主机通过IGMP协议加入组播组
- IP组播地址

	- D类地址范围为 224.0.0.0 ~ 239.255.255.255
	- 以太网组播地址块的范围为 01-00-5E-00-00-00 ~ 01-00-5E-7F-FF-FF

- 组播路由选择协议

	- 目的是找出以源主机为根节点的组播转发树（可避免环路）
	- 算法

		- 链路状态的路由选择
		- 距离-向量的路由选择
		- 协议无关的组播（PIM）

### 移动IP

- 永久地址

	- 移动站点在归属网络中的原始地址

- 转交地址

	- 移动站点在外部网络中使用的临时地址

- 移动到异地网络或返回本地网络时，辅地址改变或撤销，而主地址仍然不变

### 路由器

- 交付方式

	- 直接交付

		- 源主机和目标主机在同一个网络上，故无须通过路由器

	- 间接交付

		- 路由器按照转发表指出的路由将数据报转发给下一个路由器

- 主要功能

	- 分组转发

		- 转发表查询、转发及相关的队列管理和任务调度

	- 路由计算

		- 通过和其它路由器进行基于路由协议的交换，完成路由表的计算

- 体系结构

	- 路由选择

		- 1. 路由选择处理机
		- 2. 路由选择协议
		- 3. 路由表

	- 分组转发

		- 1. 交换结构
		- 2. 输入/输出端口

- 路由表

	- 由路由算法得出，主要用于路由选择
	- 既能隔离冲突域又能隔离广播域
	- 包含四个项目：目的网络IP地址、子网掩码、下一跳IP地址、接口

- 转发表

	- 由路由表所生成
	- 分组的实际转发是靠直接查找转发表
