# 传输层

### 功能

- 1. 提供应用进程之间端到端之间的逻辑通信
- 2. 复用和分用
- 3. 对收到的报文进行差错检测
- 4. 提供两种不同的传输协议（UDP、TCP）

### 端口

- 端口号长度为 16 bit，故可表示 65535 个不同的端口
- 分类

	- 服务器端

		- 熟知端口号：派给TCP/IP最重要的一些应用程序，范围为 0 ~ 1023
		- 登记端口号：供给没有熟知端口号的应用程序，范围为 1024 ~ 49151

	- 客户端

		- 临时端口号：仅在客户端运行时才动态地选择，范围为 49152 ~ 65535

- 扩展

	- 数据链路层的SAP是MAC地址
	- 传输层的SAP是端口地址
	- 网络层的SAP是IP地址

### UDP

- 在IP的数据报服务之上仅增加：复用和分用、差错检测
- 特点

	- 1. 无连接，减少开销和发送数据之前的延迟
	- 2. 面向报文，适合一次性传输少量数据的网络应用
	- 3. 最大努力交付，即不保证可靠交付
	- 4. 无阻塞控制，使用很多实时应用
	- 5. 首部开销小，仅 8 B

- 数据报

	- 由UDP首部和用户数据组成
	- 首部格式：源端口、目的端口、长度、校验和（各 2 B）

- 校验

	- 通过校验和检查首部和数据部分
	- 伪首部既不向下传送又不向上递交，也不计入长度，仅为了计算校验和

### TCP

- 是在不可靠传输的IP层之上实现的可靠的数据传输协议
- 特点

	- 1. 面向连接、字节流
	- 2. 提供全双工通信
	- 3. 一对一，即点对点
	- 4. 提供可靠的交付服务

- 报文段

	- 由首部和数据两部分组成
	- 首部前 20B 是固定的，其长度为 4B 的整数倍
	- TCP报文段示例图

		- 

- 连接管理

	- 建立（三次握手）

		- 1. SYN = 1, seq = x
		- 2. SYN = 1, ACK = 1, seq = y, ack = x + 1
		- 3. ACK = 1, seq = x + 1, ack = y + 1
		- 三次握手示例图

			- 

	- 释放（四次握手）

		- 1. FIN = 1, seq = u
		- 2. ACK = 1, seq = v, ack = u + 1
		- 3. FIN = 1, ACK = 1, seq = w, ack = u + 1
		- 4. ACK = 1, seq = u + 1, ack = w + 1
		- 四次握手示例图

			- 

- 可靠传输

	- 校验机制（与UDP相同）
	- 序号机制

		- 序号字段 seq 的值是指本报文段所发送的数据的第一个字节的序号

	- 确认机制

		- 确认号 ack 是指期望收到对方下一个报文段的数据的第一个字节的序号
		- 默认采用累计确认，即TCP只确认数据流中至第一个丢失字节为止的字节

	- 重传机制

		- 超时：当计时器设置的重传时间到期但还未收到确认时，需重传这一报文段
		- 冗余ACK：当发送发收到对同一报文段的3个冗余ACK时，即代表被确认报文段之后的报文已丢失，需立即重传（快速重传）

- 流量控制

	- 传输层定义端到端用户之间的流量控制
	- 数据链路层定义两个中间的相邻结点的流量控制
	- 接收窗口（rwnd）

		- 根据自己接收缓存的大小，动态地调整发送方的发送窗口的大小

	- 拥塞窗口（cwnd）

		- 根据当前网络拥塞程度的估计而确定的窗口值

- 拥塞控制

	- 接收窗口（rwnd）

		- 接收方根据目前接收缓存大小所许诺的最新窗口值，反映接收方的容量

	- 拥塞窗口（cwnd）

		- 发送发根据自己估算的网络拥塞程度而设置的窗口值，反映网络当前容量

	- 发送窗口的上限值 = min{ 接收窗口，拥塞窗口 }
	- 慢开始和拥塞避免算法

		- 在TCP连接建立和网络出现超时时，采用慢开始和拥塞避免算法
		- 慢开始

			- 每经过一次传播轮次，cwnd就会加倍（x2），其大小呈指数式增长

		- 拥塞避免算法

			- 每经过一个往返时延RTT，cwnd就会加1，其大小呈线性规律增长

		- 慢开始和拥塞避免算法的实现过程示例图

			- 

	- 快重传和快恢复

		- 当发送方接收到冗余ACK时，采用快重传和快恢复算法
		- 快重传

			- 当发送方连续收到 3 个重复的ACK报文时，直接立刻重传丢失报文段，不用等待重传计时器超时

		- 快恢复

			- 与慢开始不同之处在于，当发送方收到 3 个冗余ACK时，它把cwnd值设置为慢开始门限ssthresh改变后的数值
			- 快恢复算法的实现过程示例图

				- 
